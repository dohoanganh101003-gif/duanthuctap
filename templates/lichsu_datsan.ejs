<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>L·ªãch s·ª≠ ƒë·∫∑t s√¢n</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/trangchu.css" />
    <link rel="stylesheet" href="/datSan.css" />
    <link rel="stylesheet" href="/bang.css" />

</head>

<body>
    <header class="main-header shadow-sm">
        <nav class="navbar navbar-dark bg-primary py-3 d-flex align-items-center justify-content-between">
            <button class="btn btn-outline-light btn-sm" id="sidebarToggle">‚ò∞</button>
            <a class="navbar-brand fw-bold text-white ml-2" href="/">Qu·∫£n L√Ω S√¢n B√≥ng</a>

            <ul class="navbar-nav ml-auto flex-row">
                <% if (session && session.user_id) { %>
                    <li class="nav-item ml-3">
                        <a class="nav-link text-white" href="/dangxuat">ƒêƒÉng xu·∫•t</a>
                    </li>
                    <% } else { %>
                        <li class="nav-item ml-3">
                            <a class="nav-link text-white" href="/dangnhap">ƒêƒÉng nh·∫≠p</a>
                        </li>
                        <li class="nav-item ml-3">
                            <a class="nav-link text-white" href="/dangky">ƒêƒÉng k√Ω</a>
                        </li>
                        <% } %>
            </ul>
        </nav>
    </header>

    <div id="sidebar" class="sidebar">
        <button class="close-btn" id="closeSidebar">√ó</button>
        <ul class="sidebar-menu list-unstyled mt-4">
            <li><a href="/">Trang ch·ªß</a></li>
            <li><a href="/lichsu_datsan" class="active">L·ªãch s·ª≠ ƒë·∫∑t s√¢n</a></li>

            <% if (session && session.role==='admin' ) { %>
                <li><a href="/danhsach_sanbong">Qu·∫£n l√Ω s√¢n b√≥ng</a></li>
                <li><a href="/danhsach-dichvu">Qu·∫£n l√Ω d·ªãch v·ª•</a></li>
                <li><a href="/quanly_datsan">Qu·∫£n l√Ω ƒë·∫∑t s√¢n</a></li>
                <li><a href="/admin/users">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a></li>
                <li><a href="/thongke">Th·ªëng k√™</a></li>
                <% } %>
        </ul>
    </div>

    <main class="container mt-4">
        <h3 class="mb-4">L·ªãch s·ª≠ ƒë·∫∑t s√¢n c·ªßa b·∫°n</h3>

        <% if (session && session.user_id) { %>
            <div class="table-container">
                <table class="table table-striped table-hover table-history">
                    <thead class="thead-dark">
                        <tr>
                            <th>S√¢n</th>
                            <th>B·∫Øt ƒë·∫ßu</th>
                            <th>K·∫øt th√∫c</th>
                            <th>D·ªãch v·ª• k√®m theo</th>
                            <th>T·ªïng ti·ªÅn</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (bookings && bookings.length> 0) { %>
                            <% bookings.forEach(function(b) { %>
                                <tr>
                                    <td>
                                        <%= b.sub_field_name %> - <%= b.field_name %>
                                    </td>
                                    <td>
                                        <%= new Date(b.start_time).toLocaleString("vi-VN", { hour12: false }) %>
                                    </td>
                                    <td>
                                        <%= new Date(b.end_time).toLocaleString("vi-VN", { hour12: false }) %>
                                    </td>

                                    <td>
                                        <% if (b.services && b.services.length> 0) { %>
                                            <ul class="no-bullet">
                                                <% b.services.forEach(function(s) { %>
                                                    <li>
                                                        <%= s.name %> (<%=
                                                                Math.round(Number(s.price)).toLocaleString("vi-VN") %>
                                                                VNƒê)
                                                    </li>
                                                    <% }); %>
                                            </ul>
                                            <% } else { %>
                                                Kh√¥ng c√≥
                                                <% } %>
                                    </td>

                                    <td>
                                        <%= Math.round(Number(b.total_price)).toLocaleString("vi-VN") %> VNƒê
                                    </td>

                                    <td>
                                        <% if (b.isExpired) { %>
                                            <span class="badge badge-secondary">ƒê√£ h·∫øt h·∫°n</span>
                                            <% } else if (b.status==='pending' ) { %>
                                                <span class="badge badge-warning">ƒêang ch·ªù x√°c nh·∫≠n</span>
                                                <% } else if (b.status==='confirmed' ) { %>
                                                    <span class="badge badge-success">ƒê√£ x√°c nh·∫≠n</span>
                                                    <% } else if (b.status==='cancelled' ) { %>
                                                        <span class="badge badge-danger">ƒê√£ h·ªßy</span>
                                                        <% } %>

                                                            <% if (b.payment_status) { %>
                                                                <div class="mt-1"
                                                                    style="font-size: 0.85em; color: #555;">
                                                                    <% if (b.payment_status==='waiting_cash' ) { %>
                                                                        <div>Thanh to√°n: Ch·ªù t·∫°i s√¢n</div>
                                                                        <% } else if
                                                                            (b.payment_status==='waiting_transfer' ) {
                                                                            %>
                                                                            <div>Thanh to√°n: ƒêang ch·ªù x√°c nh·∫≠n</div>
                                                                            <% } else if (b.payment_status==='paid' ) {
                                                                                %>
                                                                                <div>Thanh to√°n: ƒê√£ ho√†n t·∫•t</div>
                                                                                <% } else if
                                                                                    (b.payment_status==='rejected' ) {
                                                                                    %>
                                                                                    <div style="color: #d9534f;">Thanh
                                                                                        to√°n b·ªã t·ª´ ch·ªëi</div>
                                                                                    <% } else if
                                                                                        (b.payment_status==='cancelled'
                                                                                        ) { %>
                                                                                        <div style="color: #6c757d;">ƒê√£
                                                                                            h·ªßy giao d·ªãch</div>
                                                                                        <% } %>
                                                                </div>
                                                                <% } %>
                                    </td>

                                    <td>
                                        <% if (b.isExpired || b.status==='cancelled' || b.payment_status==='cancelled'
                                            || b.payment_status==='rejected' ) { %>
                                            <span class="text-secondary small">Kh√¥ng th·ªÉ thao t√°c</span>

                                            <% } else if (b.status==='pending' ) { %>
                                                <span class="text-muted small">ƒêang ch·ªù x√°c nh·∫≠n</span>

                                                <% } else if (b.status==='confirmed' ) { %>
                                                    <% if (b.payment_status==='paid' ) { %>
                                                        <span class="badge badge-success">ƒê√£ thanh to√°n</span>
                                                        <% } else if (b.payment_status==='waiting_cash' ) { %>
                                                            <span class="badge badge-warning">Ch·ªù thanh to√°n t·∫°i
                                                                s√¢n</span>
                                                            <% } else if (b.payment_status==='waiting_transfer' ) { %>
                                                                <span class="badge badge-info">ƒêang ch·ªù x√°c nh·∫≠n</span>
                                                                <% } else { %>
                                                                    <button class="btn btn-warning btn-sm pay-btn"
                                                                        data-id="<%= b.id %>">Thanh to√°n</button>
                                                                    <% } %>
                                                                        <% } %>
                                    </td>
                                </tr>
                                <% }); %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="7" class="text-center">B·∫°n ch∆∞a c√≥ l·ªãch s·ª≠ ƒë·∫∑t s√¢n</td>
                                        </tr>
                                        <% } %>
                    </tbody>
                </table>
            </div>

            <div class="modal fade" id="paymentModal" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n</h5>
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                        </div>
                        <div class="modal-body text-center">
                            <p id="modalInfo" class="small text-muted">
                                Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n cho s√¢n <span id="bookingIdText"></span>
                            </p>
                            <div class="d-flex justify-content-center">
                                <button class="btn btn-success m-2" id="cashBtn">Ti·ªÅn m·∫∑t</button>
                                <button class="btn btn-primary m-2" id="transferBtn">Chuy·ªÉn kho·∫£n</button>
                            </div>

                            <div id="qrSection" class="mt-3 d-none text-center">
                                <h6>M√£ QR chuy·ªÉn kho·∫£n</h6>
                                <div id="qrContainer"></div>
                                <p class="small text-muted mt-2">
                                    Qu√©t m√£ ƒë·ªÉ chuy·ªÉn kho·∫£n, sau ƒë√≥ th√¥ng b√°o cho ch·ªß s√¢n.
                                </p>
                            </div>
                            <div id="uploadProofSection" class="mt-3 d-none text-center">
                                <h6 class="upload-title">T·∫£i ·∫£nh minh ch·ª©ng</h6>

                                <div class="upload-box" onclick="document.getElementById('paymentProof').click()">
                                    <div class="upload-icon">üìÅ</div>
                                    <p>B·∫•m ƒë·ªÉ ch·ªçn ·∫£nh ho·∫∑c k√©o th·∫£ v√†o ƒë√¢y</p>
                                </div>
                                <input type="file" id="paymentProof" name="payment_proof" accept="image/*"
                                    class="d-none" />
                                <div id="previewContainer" class="preview-container d-none">
                                    <img id="previewImage" class="preview-image" />
                                </div>
                                <button id="uploadProofBtn" class="btn btn-success btn-sm mt-3">
                                    G·ª≠i minh ch·ª©ng
                                </button>
                                <p class="small text-muted mt-2">Vui l√≤ng t·∫£i ·∫£nh ch·ª•p bi√™n lai chuy·ªÉn kho·∫£n ƒë·ªÉ ch·ªß s√¢n
                                    x√°c nh·∫≠n.</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
                        </div>
                    </div>
                </div>
            </div>
            <% } %>
    </main>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="/scripts/sidebar.js" defer></script>
    <script src="/scripts/thanhToan.js" defer></script>
    <script src="/scripts/map.js" defer></script>
</body>

</html>